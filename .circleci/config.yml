version: 2.1

orbs:
  node: dialogue/node@0.9.3

executors:
  debian:
    docker:
      - image: circleci/node:10.16.3
    working_directory: ~/project

commands:
  install-deps:
    description: Install and cache application dependencies
    steps:
      - restore_cache:
          keys:
            - v2-covid19-{{ .Branch }}-{{ checksum "package.json" }}-{{ checksum "package-lock.json" }}
            - v2-covid19-{{ .Branch }}-
            - v2-covid19-
      - run: npm ci
      - save_cache:
          key: v2-covid19-{{ .Branch }}-{{ checksum "package.json" }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
jobs:
  lint:
    executor: debian
    steps:
      - checkout
      - install-deps
      - run: npm run lint
  build-dev:
    executor: debian
    steps:
      - checkout
      - install-deps
      - run: npm run build:dev
      - run: cp -r build build-dev
      - node/persist_build:
          workspace_root: .
          workspace_path: build-dev
  build-prod:
    executor: debian
    steps:
      - checkout
      - install-deps
      - run: npm run build
      - run: cp -r build build-prod-ca
      - node/persist_build:
          workspace_root: .
          workspace_path: build-prod-ca


workflows:
  version: 2
  make-project:
    jobs:
      - lint:
          context: gemfury-download
          filters:
            branches:
              only: /.*/
      - node/test:
          name: "test"
          context: gemfury-download
          filters:
            branches:
              only: /.*/

      - build-dev:
          context: gemfury-download
          filters:
            branches:
              only: /.*/
      - node/deploy:
          name: 🚀🥀🇨🇦 deploy-dev-ca-ephemeral
          stage: dev
          place: ca
          ephemeral: yes
          context: static-cdn-deployer-dev-ca
          workspace_path: build-dev
          requires:
            - test
            - build-dev
          filters:
            branches:
              ignore:
                - master
      - node/deploy:
          name: 🚀👩‍💻🇨🇦 deploy-dev-ca
          stage: dev
          place: ca
          context: static-cdn-deployer-dev-ca
          workspace_path: build-dev
          requires:
            - build-dev
            - test
          filters:
            branches:
              only:
                - master

      - build-prod:
          context: gemfury-download
          filters:
            branches:
              only:
                - master
      - node/deploy:
          name: 🚀🇨🇦 deploy-prod-ca
          stage: prod
          place: ca
          context: static-cdn-deployer-prod-ca
          cache_strategy: create-react
          workspace_path: build-prod-ca
          requires:
            - test
            - build-prod
          filters:
            branches:
              only:
                - master
